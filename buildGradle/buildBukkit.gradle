import java.nio.charset.StandardCharsets
import java.util.zip.ZipEntry
import java.util.zip.ZipOutputStream

tasks.register("buildBukkit") {
    group = "translate core"
    description = "Build Bukkit plugin"
    dependsOn("setup")
    dependsOn("TranslateCore:build")
    dependsOn("CoreToFolia:build")
    dependsOn("build")
    doLast {
        String exportPath = getProperty("exportToBukkit")
        combined("CoreToFolia", "Folia", exportPath, (ZipOutputStream zos) -> {
            var entry = new ZipEntry("paper-plugin.yml")
            zos.putNextEntry(entry)

            var stringBuilder = new StringBuilder();
            stringBuilder.append("name: PublicTransit\n")
            stringBuilder.append("version: " + version + "\n")
            stringBuilder.append("main: org.core.implementation.folia.platform.plugin.boot.TranslateCoreBoot\n")
            stringBuilder.append("api-version: '1.20'\n")
            stringBuilder.append("softdepend: [ Vault ]\n")

            var byteIS = new ByteArrayInputStream(stringBuilder.toString().getBytes(StandardCharsets.UTF_8))
            byte[] bytes = new byte[1024];

            int length;
            while ((length = byteIS.read(bytes)) >= 0) {
                zos.write(bytes, 0, length)
            }
            byteIS.close()
            zos.closeEntry()
        })
    }
}